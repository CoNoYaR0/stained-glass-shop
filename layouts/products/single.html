{{ define "main" }}
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">

  {{/* ─────── 1) On extrait “ref” de l’URL courante ─────── */}}
  {{ $url := .Permalink }}
  {{/* Exemple : https://ton-site.tld/products/Assiette_sidi/ */}}
  {{ $parts := split (replaceRE "^https?://[^/]+/products/|/$" "" $url) "/" }}
  {{ $ref := index $parts 0 }}

  {{/* ─────── 2) On lit le JSON de métadonnées pour trouver title & description ─────── */}}
  {{ $allMeta := getJSON "data/products-metadata.json" }}
  {{ $meta := index (where $allMeta "ref" $ref) 0 }}

  {{ if $meta }}
    <title>{{ $meta.title }} · {{ .Site.Title }}</title>
    <meta name="description" content="{{ $meta.description }}">
  {{ else }}
    <title>Produit introuvable · {{ .Site.Title }}</title>
    <meta name="description" content="Ce produit n'existe pas.">
  {{ end }}

  <meta name="viewport" content="width=device-width, initial-scale=1">

  {{/* (Optionnel) OpenGraph, analytics, etc. */}}
  {{ template "_internal/opengraph.html" . }}
  {{ template "_internal/google_analytics.html" . }}

  {{/* ─────── 3) Chargement des CSS : Vex, Bootstrap, puis ton CSS perso ─────── */}}
  <link rel="stylesheet" href="{{ "scss/style.scss" | relURL }}">
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
        integrity="sha384-9ndCyUa0R+0Y7DhWR0IxCjMuJjLgCW3Xkez36Qmrh4jjvW8jDfzeUjRRV0W9+QFf"
        crossorigin="anonymous">
  <link rel="stylesheet" href="{{ "scss/style.min.css" | relURL }}" media="screen">

  {{/* Favicon */}}
  <link rel="shortcut icon" href="{{ "images/favicon.png" | relURL }}" type="image/x-icon">
  <link rel="icon"        href="{{ "images/favicon.png" | relURL }}" type="image/x-icon">
</head>

<body>
  {{ partial "header.html" . }}

  <main class="container my-5">
    <!-- 4) Loader pendant la récupération des détails -->
    <div id="product-loading" class="text-center">
      <div class="spinner-border text-secondary" role="status">
        <span class="visually-hidden">Chargement du produit…</span>
      </div>
      <p class="mt-2">Chargement du produit…</p>
    </div>

    <!-- 5) Contenu détaillé (initialement caché) -->
    <div id="product-content" class="row d-none">
      <div class="col-md-5">
        <img id="prod-image" src="" alt="" class="img-fluid rounded">
      </div>
      <div class="col-md-7">
        <h1 id="prod-title" class="mb-3"></h1>
        <p id="prod-description"></p>
        <p><strong>Prix :</strong> <span id="prod-prix"></span> DT HT</p>
        <p><strong>Stock :</strong> <span id="prod-stock"></span></p>

        <button id="single-add-to-cart" class="btn btn-warning mt-3">
          Ajouter au panier
        </button>
      </div>
    </div>
  </main>

  {{ partial "footer.html" . }}

  <!-- 6) Script pour récupérer TOUT le tableau “products” puis filtrer par ref -->
  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      const pathParts = window.location.pathname.replace(/^\/|\/$/g, "").split("/");
      const ref = pathParts.length >= 2 ? pathParts[1] : null;
      if (!ref) {
        document.getElementById("product-loading").textContent = "Produit introuvable.";
        return;
      }

      try {
        // ─── 6.1) Récupère “tous” les produits depuis le proxy Dolibarr ───
        const res = await fetch("https://cdn.stainedglass.tn/proxy/products.php");
        const products = await res.json(); // tableau d’objets

        // ─── 6.2) Cherche le bon objet en fonction de la “ref” ───
        const product = Array.isArray(products)
          ? products.find(p => p.ref === ref)
          : null;

        if (!product) {
          document.getElementById("product-loading").textContent = "Produit introuvable.";
          return;
        }

        // ─── 6.3) Remplit le DOM avec les données récupérées ───
        document.getElementById("prod-title").textContent = product.label || ref.replace(/_/g, " ");
        document.getElementById("prod-image").src = `https://cdn.stainedglass.tn/stainedglass-img-cache/${ref}.jpg`;
        document.getElementById("prod-image").alt = product.label || ref.replace(/_/g, " ");
        document.getElementById("prod-description").textContent = product.description || "Pas de description disponible.";
        document.getElementById("prod-prix").textContent = parseFloat(product.price || 0).toFixed(2);
        document.getElementById("prod-stock").textContent = product.stock_reel !== undefined
          ? product.stock_reel
          : "N/A";

        // ─── 6.4) Gestion du bouton “Ajouter au panier” ───
        document.getElementById("single-add-to-cart").addEventListener("click", () => {
          const cart = JSON.parse(localStorage.getItem("customCart") || "[]");
          const exist = cart.find(item => item.ref === product.ref);
          if (exist) {
            exist.quantity++;
          } else {
            cart.push({
              ref: product.ref,
              name: product.label || ref.replace(/_/g, " "),
              price: parseFloat(product.price || 0),
              quantity: 1,
              image: document.getElementById("prod-image").src
            });
          }
          localStorage.setItem("customCart", JSON.stringify(cart));
          alert("Produit ajouté au panier !");
        });

        // ─── 6.5) Masquer le loader et afficher le contenu ───
        document.getElementById("product-loading").classList.add("d-none");
        document.getElementById("product-content").classList.remove("d-none");
      } catch (err) {
        console.error("Erreur au chargement du produit :", err);
        document.getElementById("product-loading").textContent = "Erreur au chargement.";
      }
    });
  </script>
</body>
</html>
{{ end }}
