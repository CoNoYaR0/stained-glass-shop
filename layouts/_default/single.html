{{ define "main" }}
<section class="section">
  <div class="container">
    <div id="product-details" class="row">
      <!-- Product details will be injected here -->
    </div>
  </div>
</section>

<script>
  document.addEventListener("DOMContentLoaded", async () => {
    const slug = window.location.pathname.split('/').pop();
    const container = document.getElementById("product-details");

    try {
      const res = await fetch(`https://dolibarr-middleware.onrender.com/api/v1/products/${slug}`);
      const product = await res.json();

      if (product && product.id) {
        const { name, long_description, price, images, meta_title, meta_description } = product;

        // Set SEO meta tags
        document.title = meta_title || name;
        const metaDesc = document.querySelector('meta[name="description"]');
        if (metaDesc) {
            metaDesc.setAttribute('content', meta_description || '');
        }

        const fullImages = images || [];

        const imageGalleryHTML = fullImages.length > 0 ? `
          <div class="col-md-6">
            <div id="product-gallery" class="carousel slide" data-ride="carousel">
              <ol class="carousel-indicators">
                ${fullImages.map((_, index) => `
                  <li data-target="#product-gallery" data-slide-to="${index}" class="${index === 0 ? 'active' : ''}"></li>
                `).join('')}
              </ol>
              <div class="carousel-inner">
                ${fullImages.map((img, index) => `
                  <div class="carousel-item ${index === 0 ? 'active' : ''}">
                    <img src="${img.url}" class="d-block w-100" alt="${name}">
                  </div>
                `).join('')}
              </div>
              <a class="carousel-control-prev" href="#product-gallery" role="button" data-slide="prev">
                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                <span class="sr-only">Previous</span>
              </a>
              <a class="carousel-control-next" href="#product-gallery" role="button" data-slide="next">
                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                <span class="sr-only">Next</span>
              </a>
            </div>
          </div>
        ` : `
          <div class="col-md-6">
            <img src="/images/fallback.jpg" class="d-block w-100" alt="Fallback Image">
          </div>
        `;

        container.innerHTML = `
          ${imageGalleryHTML}
          <div class="col-md-6">
            <h1>${name}</h1>
            <h3 class="text-primary">${parseFloat(price).toFixed(2)} DT</h3>
            <div class="mt-4">${long_description || ''}</div>
            <button class="btn btn-warning btn-lg mt-4">Add to Cart</button>
          </div>
        `;
      } else {
        container.innerHTML = `
          <div class="col-12 text-center">
            <h2>Product not found</h2>
            <p>The product you are looking for does not exist.</p>
            <a href="/products" class="btn btn-primary">Back to Products</a>
          </div>
        `;
      }
    } catch (err) {
      console.error("Error fetching product details:", err);
      container.innerHTML = `
        <div class="col-12 text-center">
          <h2>Error</h2>
          <p>There was an error loading the product details.</p>
          <a href="/products" class="btn btn-primary">Back to Products</a>
        </div>
      `;
    }
  });
</script>
{{ end }}
