<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Product Details</title>
  <style>
    /* Basic reset */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
    .container { max-width: 800px; margin: 0 auto; padding: 20px; }
    .hero { width: 100%; height: 400px; background-size: cover; background-position: center; border-radius: 8px; margin-bottom: 20px; }
    .title { font-size: 2.5rem; margin-bottom: 10px; }
    .price { display: inline-block; background: #f4f4f4; padding: 8px 16px; font-size: 1.25rem; border-radius: 4px; margin-bottom: 20px; }
    .story-section { margin-bottom: 20px; }
    .story-section h2 { font-size: 1.5rem; margin-bottom: 8px; color: #555; }
    .story-section p { margin-bottom: 12px; }
    .message { text-align: center; margin-top: 50px; font-size: 1.2rem; }
  </style>
</head>
<body>
  <div class="container">
    <div id="hero" class="hero"></div>
    <h1 id="title" class="title"></h1>
    <div id="price" class="price"></div>
    <div id="story"></div>
    <div id="message" class="message"></div>
  </div>

  <script>
    (async () => {
      const API_BASE = 'https://dolibarr-middleware.onrender.com';
      const params = new URLSearchParams(window.location.search);
      const slugParam = params.get('slug');
      const skuParam  = params.get('sku');
      const messageEl = document.getElementById('message');

      if (!slugParam && !skuParam) {
        messageEl.textContent = 'No product specified.';
        return;
      }

      try {
        // Determine slug to use: prefer slugParam, otherwise lookup by SKU
        const slug = slugParam || await lookupSlugBySku(skuParam);
        await fetchAndRender(slug);
      } catch (err) {
        messageEl.textContent = err.message || 'An error occurred.';
      }

      // Fetch list endpoint and extract array for SKU lookup
      async function lookupSlugBySku(sku) {
        const resp = await fetch(`${API_BASE}/api/v1/products?limit=1000`);
        if (!resp.ok) throw new Error('Failed to fetch product list');
        const body = await resp.json();
        // The API might return { data: [...] } or an array directly
        const list = Array.isArray(body)
          ? body
          : (Array.isArray(body.data) ? body.data : []);
        const product = list.find(item => item.sku === sku);
        if (!product) throw new Error('Product not found.');
        return product.slug;
      }

      async function fetchAndRender(slug) {
        const resp = await fetch(`${API_BASE}/api/v1/products/${encodeURIComponent(slug)}`);
        if (!resp.ok) throw new Error('Product not found.');
        const product = await resp.json();
        renderProduct(product);
      }

      function renderProduct(product) {
        // Hero image
        const heroEl = document.getElementById('hero');
        const imgUrl = Array.isArray(product.images) && product.images.length
          ? (product.images[0].url || product.images[0])
          : '';
        if (imgUrl) heroEl.style.backgroundImage = `url('${imgUrl}')`;

        // Title & price
        document.getElementById('title').textContent = product.name || 'Unnamed Product';
        document.getElementById('price').textContent =
          product.price ? `$${parseFloat(product.price).toFixed(2)}` : 'Price unavailable';

        // Storytelling description
        const storyEl = document.getElementById('story');
        const desc = product.description || '';
        const sentences = desc.split(/\.\s+/).filter(s => s.trim());
        sentences.forEach((sentence, i) => {
          const section = document.createElement('div');
          section.className = 'story-section';
          const heading = document.createElement('h2');
          heading.textContent = `Part ${i + 1}`;
          const para = document.createElement('p');
          para.textContent = sentence.trim().replace(/\.$/, '') + '.';
          section.appendChild(heading);
          section.appendChild(para);
          storyEl.appendChild(section);
        });
      }
    })();
  </script>
</body>
</html>
