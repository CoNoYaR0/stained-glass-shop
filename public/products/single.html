<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Product Details</title>
<style>
  /* … (même CSS que ton original, inchangé) … */
</style>
</head>
<body>
  <div class="container">
    <div id="product-details" class="product-container">
      <div class="product-image-gallery">
        <img id="main-image" class="main-image" src="https://via.placeholder.com/400" alt="Product image">
        <div id="thumbnail-gallery" class="thumbnail-gallery"></div>
      </div>

      <div class="product-info">
        <h1 id="product-title"></h1>
        <p id="product-tags"   class="product-tags"></p>
        <div id="product-description" class="product-description"></div>
        <p id="product-price" class="product-price"></p>
        <p id="product-stock" class="product-stock"></p>

        <div id="variant-selector" class="variant-selector"></div>

        <button id="add-to-cart-btn" class="add-to-cart-btn" disabled>Add to Cart</button>
      </div>
    </div>

    <div id="loading">Loading…</div>
    <div id="error"   style="display:none;color:red;"></div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  /* ---------------------------------------------------------------------- */
  const API_URL   = 'https://dolibarr-middleware.onrender.com/api/v1/products';
  const PING_URL  = 'https://dolibarr-middleware.onrender.com/health';
  const FALLBACK  = 'https://via.placeholder.com/400';

  /* -------- éléments DOM -------- */
  const $details   = document.getElementById('product-details');
  const $loading   = document.getElementById('loading');
  const $error     = document.getElementById('error');
  const $mainImg   = document.getElementById('main-image');
  const $thumbs    = document.getElementById('thumbnail-gallery');
  const $title     = document.getElementById('product-title');
  const $tags      = document.getElementById('product-tags');
  const $desc      = document.getElementById('product-description');
  const $price     = document.getElementById('product-price');
  const $stock     = document.getElementById('product-stock');
  const $selector  = document.getElementById('variant-selector');
  const $btnCart   = document.getElementById('add-to-cart-btn');

  let variants = [];

  /* ------------------- utils -------------------- */
  const showError = msg => {
    $error.textContent = `Error: ${msg}`;
    $error.style.display = 'block';
    $details.style.display = 'none';
  };

  const keepAlive = () => {
    fetch(PING_URL).catch(()=>{});
    setInterval(()=>fetch(PING_URL).catch(()=>{}), 10*60*1000);
  };

  /* ------------------- fetch -------------------- */
  const fetchProductBySku = async sku => {
    $loading.style.display = 'block';
    $details.style.display = 'none';
    $error.style.display   = 'none';

    try {
      const res  = await fetch(`${API_URL}?sku=${encodeURIComponent(sku)}`);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const json = await res.json();
      const items = Array.isArray(json.data) ? json.data : json;

      if (!items || !items.length) throw new Error('Product not found.');

      variants = items;                         // toutes les variantes
      renderProduct(variants[0]);               // première variante par défaut
      $details.style.display = 'flex';
    } catch (e) {
      showError(e.message);
    } finally {
      $loading.style.display = 'none';
    }
  };

  /* ---------------- render helpers -------------- */
  const renderProduct = variant => {
    // --- titre nettoyé -------------------------------------
    const cleanSku = variant.sku
      .replace(/_C\d+$/i,'')
      .replace(/[_-]/g,' ')
      .trim();
    $title.textContent = cleanSku;
    document.title = cleanSku;

    // --- tags / catégories ---------------------------------
    $tags.textContent = (variant.categories ?? [])
      .map(c => c.name || c.label)
      .filter(Boolean)
      .join(', ') || 'Uncategorized';

    // --- description (HTML déjà safe issu du back) ---------
    $desc.innerHTML = variant.description || '';

    // --- galerie ------------------------------------------
    renderGallery(variant);

    // --- variantes ----------------------------------------
    if (variants.length > 1) renderVariantSelector();
    updateVariant(variant.id);                  // mise à jour prix / stock
  };

  /* galerie */
  const renderGallery = variant => {
    const images = variant.images ?? [];
    const first  = images[0]?.cdn_url || images[0]?.url || FALLBACK;
    $mainImg.src = first;
    $thumbs.innerHTML = '';

    images.forEach((img, i) => {
      const url = img.cdn_url || img.url;
      const el  = document.createElement('img');
      el.src = url;
      el.alt = `thumb-${i}`;
      el.className = 'thumbnail' + (i===0 ? ' selected':'');
      el.addEventListener('click',()=> {
        $mainImg.src = url;
        document.querySelectorAll('.thumbnail').forEach(t=>t.classList.remove('selected'));
        el.classList.add('selected');
      });
      $thumbs.appendChild(el);
    });
  };

  /* sélecteur de variantes */
  const renderVariantSelector = () => {
    $selector.innerHTML = '';
    // s’il n’y a pas d’attributeType dans l’API, on bascule sur dropdown
    const useDropdown = !variants[0].attributeType || variants[0].attributeType === 'Generic';

    if (useDropdown) {
      const sel = document.createElement('select');
      sel.className = 'variant-select';
      variants.forEach(v => {
        const opt = document.createElement('option');
        opt.value = v.id;
        opt.textContent = v.attributeValue || v.sku;
        sel.appendChild(opt);
      });
      sel.addEventListener('change', e => updateVariant(e.target.value));
      $selector.appendChild(sel);
    } else if (variants[0].attributeType === 'Color') {
      const wrap = document.createElement('div');
      wrap.className = 'color-swatches';
      variants.forEach(v => {
        const s = document.createElement('div');
        s.className = 'color-swatch';
        s.style.backgroundColor = v.attributeValue;
        s.title = v.attributeValue;
        s.dataset.id = v.id;
        s.addEventListener('click', () => {
          updateVariant(v.id);
          document.querySelectorAll('.color-swatch').forEach(x=>x.classList.remove('selected'));
          s.classList.add('selected');
        });
        wrap.appendChild(s);
      });
      $selector.appendChild(wrap);
    }
  };

  /* maj quand on change de variante */
  const updateVariant = id => {
    const v = variants.find(x=>String(x.id)===String(id));
    if (!v) return;

    // prix
    $price.textContent = `${Math.round(v.price)} TND`;

    // stock
    const qty = v.stock ?? v.stock_levels?.[0]?.quantity ?? 0;
    if (qty>0) {
      $stock.textContent = `${qty} in stock`;
      $stock.className = 'product-stock';
      $btnCart.disabled = false;
    } else {
      $stock.textContent = 'Out of stock';
      $stock.className = 'product-stock out-of-stock';
      $btnCart.disabled = true;
    }

    // btn data-attrs
    $btnCart.dataset.id    = v.id;
    $btnCart.dataset.name  = $title.textContent;
    $btnCart.dataset.price = v.price;
    $btnCart.dataset.image = v.images?.[0]?.cdn_url || v.images?.[0]?.url || $mainImg.src;
  };

  /* attache panier (fallback) */
  const attachAddToCart = () => {
    if (window.attachAddToCartButtons) {
      window.attachAddToCartButtons();
    } else {
      $btnCart.addEventListener('click', () => {
        if ($btnCart.disabled) return;
        alert(`Added to cart:\n${$btnCart.dataset.name} – ${$btnCart.dataset.price} TND`);
      });
    }
  };

  /* ------------------ init ------------------- */
  const sku = new URLSearchParams(location.search).get('sku');
  if (sku) {
    fetchProductBySku(decodeURIComponent(sku)).then(attachAddToCart);
  } else {
    showError('No product SKU provided in URL.');
  }
  keepAlive();
});
</script>
</body>
</html>
